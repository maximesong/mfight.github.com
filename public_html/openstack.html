<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>openstack</title>
    <meta name="generator" content="muse.el" />
    <meta http-equiv="Content-Type"
          content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="style.css" /><script type="text/javascript"src="scripts/shCore.js"></script><script type="text/javascript"src="scripts/shBrushCpp.js"></script><script type="text/javascript"src="scripts/shBrushBash.js"></script><link href="styles/shCore.css" rel="stylesheettype="text/css" /><link href="styles/shThemeEmacs.css" rel="stylesheet"type="text/css" /> <script type="text/javascript"> var _gaq = _gaq || [];_gaq.push(['_setAccount', 'UA-25182468-1']);_gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ga, s);})();</script>
  </head>
  <body>
    <h1>openstack</h1>
<!-- menu start here -->
     <div class="menu">
        <div class="menuitem">
          <a href=" ../index.html">Home</a>
        </div>

        <div class="menuitem">
          <a href=" index.html">Computer</a>
        </div>
       </div>
     <div class="menub">       
	<div class="menuitemb">
          <a href=" francais.html">Français</a>
        </div>

        <div class="menuitemb">
          <a href=" word_list.html">Wordlist</a>
        </div>
      </div>
    <!-- menu ends here -->
    <!-- Page published by Emacs Muse begins here -->
<div class="mulu">
<h6 class="mulu">Contents</h6>
<dl class="contents">
<dt class="contents">
<a href="#sec1">脚本安装</a>
</dt>
<dd>
<dl class="contents">
<dt class="contents">
<a href="#sec2">安装Ubtuntu 11.10(Oneiric)</a>
</dt>
<dt class="contents">
<a href="#sec3">下载DevStack脚本</a>
</dt>
<dd>
<dl class="contents">
<dt class="contents">
<a href="#sec4">安装git</a>
</dt>
<dt class="contents">
<a href="#sec5">下载脚本</a>
</dt>
</dl>
</dd>
<dt class="contents">
<a href="#sec6">运行脚本</a>
</dt>
<dt class="contents">
<a href="#sec7">安装期间</a>
</dt>
<dd>
<dl class="contents">
<dt class="contents">
<a href="#sec8">可能遇到的错误</a>
</dt>
</dl>
</dd>
<dt class="contents">
<a href="#sec9">安装完成</a>
</dt>
<dd>
<dl class="contents">
<dt class="contents">
<a href="#sec10">访问Dashboard</a>
</dt>
</dl>
</dd>
<dt class="contents">
<a href="#sec11">Virtualbox</a>
</dt>
</dl>
</dd>
<dt class="contents">
<a href="#sec12">脚本学习</a>
</dt>
<dd>
<dl class="contents">
<dt class="contents">
<a href="#sec13">相关bash命令与变量</a>
</dt>
<dd>
<dl class="contents">
<dt class="contents">
<a href="#sec14">. </a>
</dt>
<dt class="contents">
<a href="#sec15">￥EUID</a>
</dt>
<dt class="contents">
<a href="#sec16">￥USER</a>
</dt>
<dt class="contents">
<a href="#sec17">var=￥{str:-expr}</a>
</dt>
<dt class="contents">
<a href="#sec18">getent database [key ...]</a>
</dt>
<dt class="contents">
<a href="#sec19">tee [OPTION]... [FILE]..</a>
</dt>
<dt class="contents">
<a href="#sec20">mktemp</a>
</dt>
<dt class="contents">
<a href="#sec21">/sbin/ifconfig eth0 |grep -m 1 'inet addr:' |cut -d: -f2 |awk '{print ￥1}'</a>
</dt>
<dt class="contents">
<a href="#sec22">read -e ￥var</a>
</dt>
<dt class="contents">
<a href="#sec23">tr -cd [SET]</a>
</dt>
<dt class="contents">
<a href="#sec24">trap [[arg] sigspec ...]</a>
</dt>
<dt class="contents">
<a href="#sec25">dpkg -l </a>
</dt>
<dt class="contents">
<a href="#sec26">useradd -U -G  -s  -d  -m </a>
</dt>
<dt class="contents">
<a href="#sec27">grep -q  </a>
</dt>
<dt class="contents">
<a href="#sec28">chown -R  </a>
</dt>
<dt class="contents">
<a href="#sec29">whoami</a>
</dt>
<dt class="contents">
<a href="#sec30">id -g</a>
</dt>
</dl>
</dd>
<dt class="contents">
<a href="#sec31">待确定命令</a>
</dt>
<dd>
<dl class="contents">
<dt class="contents">
<a href="#sec32">~=</a>
</dt>
<dt class="contents">
<a href="#sec33">set -o xtrace / set +o xtrace</a>
</dt>
<dt class="contents">
<a href="#sec34">STACK_DIR="￥DEST/￥{PWD##*/}"</a>
</dt>
</dl>
</dd>
</dl>
</dd>
<dt class="contents">
<a href="#sec35">脚本拆解手动安装</a>
</dt>
<dd>
<dl class="contents">
<dt class="contents">
<a href="#sec36">目录结构</a>
</dt>
<dt class="contents">
<a href="#sec37">安装步骤</a>
</dt>
<dd>
<dl class="contents">
<dt class="contents">
<a href="#sec38">查看本机ip</a>
</dt>
<dt class="contents">
<a href="#sec39">安装apt包</a>
</dt>
<dt class="contents">
<a href="#sec40">安装python依赖</a>
</dt>
<dt class="contents">
<a href="#sec41">git库下载</a>
</dt>
<dt class="contents">
<a href="#sec42">安装git库</a>
</dt>
<dt class="contents">
<a href="#sec43">安装syslog</a>
</dt>
<dt class="contents">
<a href="#sec44">安装rabbitmq</a>
</dt>
<dt class="contents">
<a href="#sec45">安装mysql</a>
</dt>
<dt class="contents">
<a href="#sec46">安装horizon服务器</a>
</dt>
<dt class="contents">
<a href="#sec47">配置glance</a>
</dt>
<dt class="contents">
<a href="#sec48">配置nova</a>
</dt>
<dt class="contents">
<a href="#sec49">安装libvirt-bin</a>
</dt>
<dt class="contents">
<a href="#sec50">清除iptables规则</a>
</dt>
<dt class="contents">
<a href="#sec51">删除旧的instances</a>
</dt>
<dt class="contents">
<a href="#sec52">建立nova-network文件夹</a>
</dt>
<dt class="contents">
<a href="#sec53">配置储存服务</a>
</dt>
<dt class="contents">
<a href="#sec54">配置volume service</a>
</dt>
<dt class="contents">
<a href="#sec55">配置nova</a>
</dt>
<dt class="contents">
<a href="#sec56">配置nova数据库</a>
</dt>
<dt class="contents">
<a href="#sec57">配置keystone</a>
</dt>
<dt class="contents">
<a href="#sec58">开启服务</a>
</dt>
<dt class="contents">
<a href="#sec59">未完待续。。。</a>
</dt>
</dl>
</dd>
</dl>
</dd>
<dt class="contents">
<a href="#sec60">ISO 安装</a>
</dt>
</dl>
</div>

<h2><a name="sec1" id="sec1"></a>脚本安装</h2>

<p class="first">通过devstack.org提供的shell脚本来安装和配置openstack。
<h3><a name="sec2" id="sec2"></a>安装Ubtuntu 11.10(Oneiric)</h3></p>

<p>最稳妥的是安装Ubuntu Server 11.10 64bits。我在Unbuntu Desktop Edition上也试过运行脚本，但是会出现Host Ip没有指定的情况，应该另外配置一下就可以了，但我没有继续研究下去。</p>


<h3><a name="sec3" id="sec3"></a>下载DevStack脚本</h3>

<h4><a name="sec4" id="sec4"></a>安装git</h4>

<p class="first">下载脚本需要用到git，如果你的系统还没有安装过git，可以在控制台中用下面的命令安装。

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install git
</pre>
</p>


<h4><a name="sec5" id="sec5"></a>下载脚本</h4>

<p class="first">cd到准备存放脚本的文件夹下，然后在控制台执行下面的命令。

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
git clone git://github.com/cloudbuilders/devstack.git
</pre>
</p>



<h3><a name="sec6" id="sec6"></a>运行脚本</h3>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cd devstack # The folder you just cloned
./stack.sh # run the script
</pre>



<h3><a name="sec7" id="sec7"></a>安装期间</h3>

<ul>
<li>第一次安装时，脚本可能会提示你设置几个密码，不要嫌烦哦。</li>
<li>如果想要修改默认的配置，可以在顶层文件夹中新建一个localrc文件进行配置。当然你也可以直接修改现有的配置文件（我就是这么干的）。</li>
<li>安装时间可能会比较长，趁次机会，不妨看一看<a href="http://devstack.org/stack.sh.html">脚本</a>究竟干了些什么，注释还是很详细的。</li>
</ul>

<h4><a name="sec8" id="sec8"></a>可能遇到的错误</h4>

<ul>
<li>卡在某个地方

<ul>
<li>在安装python的一些程序时，我遇到过卡在<code>Downloading/Unpacking django-nose-selenium</code>的情况，尝试过修改配置文件，但没有成功，卡住的具体原因不明。</li>
<li>解决方法：手动进行安装</li>
</ul></li>
</ul>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
pip install django-nose-selenium
</pre>

虽然安装的版本可能和脚本默认的不太一样，不过最后的Dashboard一切正常，那就无所谓了。

<ul>
<li>gzip: stdin: not in gzip format

<ul>
<li>尝试了很多办法，最后发现是因为一个压缩包没有下载完整，脚本再次运行时也没有重新下载，导致解压的这一步一直报错</li>
<li>解决方法：手动下载完整的压缩包进行覆盖，重新运行脚本

<ul>
<li>当然我想删掉压缩包，重新运行脚本可能也是可以的。</li>
</ul></li>
</ul></li>
</ul>



<h3><a name="sec9" id="sec9"></a>安装完成</h3>

<p class="first">安装完成后会提示你各个配置信息,包括默认的用户名和密码。
比如访问Dashboard的地址<code>horizon is now available at http://10.0.2.15/</code>
<h4><a name="sec10" id="sec10"></a>访问Dashboard</h4></p>

<p>即使Ubuntu Server默认没有安装桌面环境，一样可以通过控制台中的浏览器访问Dashboard

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
w3m http://10.0.2.15
</pre>

<h5>登录页面是这样的</h5></p>

<p class="image"><img src="w3m_login.png" alt="" /></p>


<h5>登录后</h5>

<p class="image"><img src="w3m_logged.png" alt="" /></p>




<h3><a name="sec11" id="sec11"></a>Virtualbox</h3>

<p class="first">如果是在Virtualbox中安装openstack，可以通过NAT和Port Forwarding在原来的系统(Host)内访问虚拟机中系统(Guest)的服务。其原理是将发向Host的某个Ip地址和端口的请求转发给Guest的某个Ip地址和端口，达到在Host上访问Guest的目的，具体设置步骤如下</p>

<ul>
<li>右键单击虚拟机系统，选择Settings</li>
<li>在左边的选项栏中选择Network</li>
<li>点击Advanced</li>
<li>点击Port Forwarding,进行设置</li>
</ul>

<h5>网络设置</h5>

<p class="image"><img src="network_settings.png" alt="" /></p>


<h5>Port Forwaring设置</h5>

<p class="image"><img src="port_forwarding.png" alt="" /></p>


<h5>登录</h5>

<p class="image"><img src="openstack_login.png" alt="" /></p>


<h5>登录后</h5>

<p class="image"><img src="openstack_logged.png" alt="" /></p>




<h2><a name="sec12" id="sec12"></a>脚本学习</h2>

<p class="first">注意，下面￥的地方其实都是￥。
<h3><a name="sec13" id="sec13"></a>相关bash命令与变量</h3></p>

<h4><a name="sec14" id="sec14"></a>. &lt;filename&gt;</h4>

<ul>
<li>相当于source &lt;filename&gt;，执行filename文件种的脚本</li>
</ul>


<h4><a name="sec15" id="sec15"></a>￥EUID</h4>

<ul>
<li>用户权限, 0为特权用户</li>
</ul>


<h4><a name="sec16" id="sec16"></a>￥USER</h4>

<ul>
<li>当前用户</li>
</ul>


<h4><a name="sec17" id="sec17"></a>var=￥{str:-expr}</h4>

<ul>
<li>如果str未赋值或为空，var=expr</li>
<li>否则，var=￥str</li>
</ul>


<h4><a name="sec18" id="sec18"></a>getent database [key ...]</h4>

<ul>
<li>从一些文本数据库中获取我们需要的信息，如getent passwd joe</li>
</ul>


<h4><a name="sec19" id="sec19"></a>tee [OPTION]... [FILE]..</h4>

<ul>
<li>从标准输入读入，写入到标准输出和文件</li>
</ul>


<h4><a name="sec20" id="sec20"></a>mktemp</h4>

<ul>
<li>创建临时文件或临时目录</li>
</ul>


<h4><a name="sec21" id="sec21"></a>/sbin/ifconfig eth0 |grep -m 1 'inet addr:' |cut -d: -f2 |awk '{print ￥1}'</h4>

<h5>grep -m 1 &quot;inet addr:&quot;</h5>

<ul>
<li>第一次匹配成功就结束</li>
</ul>


<h5>cut -d: -f2</h5>

<ul>
<li>以“：”来划分块，保留2个块</li>
</ul>



<h4><a name="sec22" id="sec22"></a>read -e ￥var</h4>

<ul>
<li>读行</li>
</ul>


<h4><a name="sec23" id="sec23"></a>tr -cd [SET]</h4>

<ul>
<li>从标准输入读入，对&lt;SET&gt;取反，从输入中删除取反后&lt;SET&gt;中的字符，输出到标准输出》</li>
</ul>


<h4><a name="sec24" id="sec24"></a>trap [[arg] sigspec ...]</h4>

<ul>
<li>当收到sigspec信号时，读取和执行arg命令</li>
</ul>


<h4><a name="sec25" id="sec25"></a>dpkg -l &lt;package&gt;</h4>

<ul>
<li>dpkg是debian的包管理工具，这条命令列出匹配的包</li>
</ul>


<h4><a name="sec26" id="sec26"></a>useradd -U -G &lt;group&gt; -s &lt;shell&gt; -d &lt;home_dir&gt; -m &lt;create_home&gt;</h4>

<ul>
<li>增加用户，-U，-G增加用户组，-s确定使用的shell，-d为登录目录，-m为创建的用户目录</li>
</ul>



<h4><a name="sec27" id="sec27"></a>grep -q &lt;pattern&gt; &lt;file&gt;</h4>

<ul>
<li>grep结果不输出到标准输出（quietly）</li>
</ul>


<h4><a name="sec28" id="sec28"></a>chown -R &lt;user&gt; &lt;dir&gt;</h4>

<ul>
<li>改变目录和其子目录、文件的拥有者</li>
</ul>


<h4><a name="sec29" id="sec29"></a>whoami</h4>

<ul>
<li>输出当前用户名</li>
</ul>


<h4><a name="sec30" id="sec30"></a>id -g</h4>

<ul>
<li>输出用户组（数字）</li>
</ul>



<h3><a name="sec31" id="sec31"></a>待确定命令</h3>

<h4><a name="sec32" id="sec32"></a>~=</h4>

<ul>
<li>怀疑是smart operator，含有多种功能</li>
</ul>


<h4><a name="sec33" id="sec33"></a>set -o xtrace / set +o xtrace</h4>

<ul>
<li>疑似-o在标准输出时再次输出命令，+o则不重复输出命令</li>
</ul>


<h4><a name="sec34" id="sec34"></a>STACK_DIR=&quot;￥DEST/￥{PWD##*/}&quot;</h4>

<ul>
<li>未知</li>
</ul>






<h2><a name="sec35" id="sec35"></a>脚本拆解手动安装</h2>

<p class="first">安装环境为 ubuntu 11.10 server 64bits，语言选择英语。由于手动安装加入了“人工智能”，相对脚本有所简化，不过通用性不如脚本来得好。
<h3><a name="sec36" id="sec36"></a>目录结构</h3></p>

<ul>
<li>functions 常用函数</li>
<li>stackrc 大部分为默认的git clone地址，并读取localrc的内容</li>
<li>files（D） 安装依赖、配置模板等</li>
</ul>


<h3><a name="sec37" id="sec37"></a>安装步骤</h3>

<p class="first">假设用户名为openstack，密码为opensecret</p>

<h4><a name="sec38" id="sec38"></a>查看本机ip</h4>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
ifconfig eth0
</pre>
记录结果中的<code>inet addr:</code>后的ip地址，如<code>10.0.2.15</code>我们记为<code>&lt;host_ip&gt;</code>，稍后使用。


<h4><a name="sec39" id="sec39"></a>安装apt包</h4>

<h5>更新</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get update
</pre>


<h5>安装通用包</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install pep8 pylint python-pip screen unzip wget psmisc git-core \
     lsof openssh-server vim-nox locate python-virtualenv python-unittest2 \
     iputils-ping wget curl tcpdump euca2ools
</pre>


<h5>安装nova包</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install dnsmasq-base dnsmasq-utils kpartx parted iputils-arping \
     python-mysqldb python-xattr python-lxml kvm gawk iptables ebtables \
     sqlite3 kvm vlan curl socat python-mox python-paste python-migrate \
     python-gflags python-greenlet python-libvirt python-libxml2 \
     python-routes python-netaddr python-pastedeploy python-eventlet \
     python-cheetah
</pre>


<h5>安装swift包</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install curl gcc python-configobj python-coverage python-dev \
     python-eventlet python-greenlet python-netifaces python-nose \
     python-pastedeploy python-setuptools python-simplejson python-webob \
     python-xattr sqlite3 xfsprogs
</pre>


<h5>安装glance包</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install python-eventlet python-routes python-greenlet \
     python-argparse python-sqlalchemy python-wsgiref python-pastedeploy \
     python-xattr
</pre>


<h5>安装keystone包</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install python-setuptools python-dev python-lxml \
     python-pastescript python-pastedeploy python-paste sqlite3 \
     python-pysqlite2 python-sqlalchemy python-webob python-greenlet \
     python-routes libldap2-dev libsasl2-dev
</pre>


<h5>安装horizon包</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install python-dateutil python-paste python-pastedeploy \
     python-anyjson python-routes python-xattr python-sqlalchemy python-webob \
     python-kombu pylint pep8 python-evenlet python-nose python-mox \
     python-coverage python-cherrypy3 python-django python-django-mailer \
     python-django-nose python-django-registration python-cloudfiles \
     python-migrate
</pre>


<h5>安装其他nova包</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install python-dateutil lvm2 open-iscsi open-iscsi-utils \
     python-numpy tgt
</pre>



<h4><a name="sec40" id="sec40"></a>安装python依赖</h4>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo pip install django-nose-selenium pycrypto==2.3 PassLib pika
</pre>


<h4><a name="sec41" id="sec41"></a>git库下载</h4>

<h5>下载nova&amp;nova-client</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
git clone https://github.com/openstack/nova.git
git clone https://github.com/openstack/python-novaclient.git
</pre>


<h5>下载novnc</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
git clone https://github.com/cloudbuilders/noVNC.git
</pre>


<h5>下载swift</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
git clone https://github.com/openstack/swift.git
</pre>


<h5>下载glance</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
git clone https://github.com/openstack/glance.git
</pre>


<h5>下载keystone&amp;keystone-client&amp;swift-keystone</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
git clone https://github.com/openstack/keystone
git clone https://github.com/cloudbuilders/swift-keystone2.git
git clone https://github.com/openstack/python-keystoneclient
</pre>


<h5>下载horizon</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
git clone https://github.com/openstack/horizon.git
</pre>


<h5>下载quantum&amp;quantum-client</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
git clone https://github.com/openstack/quantum
git clone https://github.com/openstack/python-quantumclient
</pre>


<h5>下载melange&amp;melange-client</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
git clone https://github.com/openstack/melange.git
git clone https://github.com/openstack/python-melangeclient.git
</pre>



<h4><a name="sec42" id="sec42"></a>安装git库</h4>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cd keystone
sudo python setup develop
cd ../swift
sudo python setup develop
cd ../swift-keystone2
sudo python setup develop

cd ../glance
sudo python setup develop

cd ../python-novaclient
sudo python setup develop

cd ../nova
sudo python setup develop

cd ../python-keystoneclient
sudo python setup develop

cd ../horizen/horizen
sudo python setup develop

cd ../openstack-dashboard
sudo python setup develop

cd ../../quantum
sudo python setup develop

cd ../melange
sudo python setup develop
cd ../python-melangeclient
sudo python setup develop

</pre>


<h4><a name="sec43" id="sec43"></a>安装syslog</h4>

<p class="first">略</p>


<h4><a name="sec44" id="sec44"></a>安装rabbitmq</h4>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install rabbitmq-server
sudo rabbitmqctl change_password guest <rabbit_passwd> #密码从guest改为<rabbit_passwd>
</pre>


<h4><a name="sec45" id="sec45"></a>安装mysql</h4>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install mysql-server
</pre>

<ul>
<li>期间设置mysql密码，记为&lt;mysql_root_passwd&gt;</li>
</ul>

<h5>配置mysql用户</h5>

<p>新建~/.my.conf,并及加入下面几行的内容</p>

<pre class="example">
[client]
user=root
password=&lt;mysql_root_passwd&gt;
host=localhost
</pre>
运行下面命令设置文件的权限
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
chmod 0600 ~/.my.cnf
</pre>
修改配置，使得mysql绑定到任意的ip地址，然后重启mysql服务
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo sed -i 's/127.0.0.1/0.0.0.0/g' /etc/mysql/my.cnf
sudo service mysql restart
</pre>



<h4><a name="sec46" id="sec46"></a>安装horizon服务器</h4>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install apache2 libapache2-mod-wsgi
</pre>
链接到quantum
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
rm -fr horizon/openstack-dashboard/quantum
ln -s python-quantumclient/quantum horizon/openstack-dashboard/quantum
</pre>
删除没用的数据库
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
rm -f horizon/openstack-dashboard/local/dashboard_openstack.sqlite3
</pre>
复制horizon的设置
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cp files/horizon_settings.py horizon/openstack-dashboard/local/local_settings.py
</pre>
在设置文件中启用quantum
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo sed -e "s,QUANTUM_ENABLED = False,QUANTUM_ENABLED = True,g" -i horizon/openstack-dashboard/local/local_settings.py
</pre>
初始化数据库
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cd horizon/openstack-dashboard/
python manage.py syncdb
</pre>
创建apache使用的目录
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo mkdir -p horizon/.blackhole
</pre>
配置apache，运行horizon，记当前用户为&lt;user&gt;
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo cp $FILES/000-default.template /etc/apache2/sites-enabled/000-default
sudo sed -e "
     s,%USER%,<user>,g;
     s,%GROUP%,<user>,g;
     s,%HORIZON_DIR%,/home/<user>/devstack/horizon,g;
     " -i /etc/apache2/sites-enabled/000-default
sudo service apache2 restart
</pre>


<h4><a name="sec47" id="sec47"></a>配置glance</h4>

<p class="first">建立images目录
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
mkdir -p glance/images
</pre>
配置glance的mysql
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
mysql -uroot -p<mysql_passwd> -e 'CREATE DATABASE glance;'
</pre>
复制glance-registry配置模板
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cp files/glance-registry.conf glance/etc/glance-registry.conf
</pre>
修改glance/etc/glance-registry.conf，将内容按照如下替换,其中&lt;service_token&gt;为自己设定的口令</p>

<ul>
<li>%KEYSTONE_AUTH_HOST% -&gt; &lt;host_ip&gt;</li>
<li>%KEYSTONE_AUTH_PORT% -&gt; 35357</li>
<li>%KEYSTONE_AUTH_PROTOCOL% -&gt; http</li>
<li>%KEYSTONE_SERVICE_HOST% -&gt; &lt;host_ip&gt;</li>
<li>%KEYSTONE_SERVICE_PORT% -&gt; 5000</li>
<li>%KEYSTONE_SERVICE_PROTOCOL% -&gt; http</li>
<li>%SERVICE_TOKEN -&gt; &lt;service_token&gt;</li>
<li>%SQL_CONN% -&gt; mysql://root:&lt;mysql_passwd&gt;@localhost/glance</li>
<li>%DEST% -&gt; /home/&lt;user&gt;/devstack/</li>
<li>%SYSLOG% -&gt; False</li>
</ul>

<p>复制glance-registry初始化配置
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cp files/glance-registry-paste.ini glance/etc/glance-registry-paste.ini
</pre></p>

<p>对glance/etc/glance-registry-paste.ini的内容做和上面相同的替换。</p>

<p>将glance-registry初始化配置文件的内容加入到配置文件中
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cat glance/etc/glance-registry-paste.ini >> glance/etc/glance-registry.conf
</pre></p>

<p>复制glance-api配置
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cp files/glance-api.conf glance/etc/glance-api.conf
</pre>
对glance/etc/glance-api.conf做用同样的替换处理</p>

<p>复制glance-api初始化配置
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cp files/glance-api-paste.ini glance/etc/glance-api-paste.ini
</pre></p>

<p>对glance-api-paste.ini做同样的替换处理</p>

<p>将glance-api初始化配置加入到配置文件中
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cat glance/etc/glance-api-paste.ini >> glance/etc/glance-api.conf
</pre></p>


<h4><a name="sec48" id="sec48"></a>配置nova</h4>

<p class="first">复制nova的初始化文件
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
cp nova/etc/nova/api-paste.ini nova/bin/nova-api-paste.ini
</pre>
替换nova/bin/nova-api-paste.ini的内容</p>

<ul>
<li>%SERVICE_TOKEN% -&gt; &lt;service_token&gt;</li>
<li>ec2cloud -&gt; ec2faultwrap logrequest totoken authtoken keystonecontext cloudrequest authorizer validator ec2executor</li>
<li>ec2admin -&gt; ec2faultwrap logrequest totoken authtoken keystonecontext adminrequest authorizer ec2executor</li>
<li>openstack_compute_api_v2 -&gt; faultwrap authtoken keystonecontext ratelimit osapi_compute_app_v2</li>
<li>openstack_volume_api_v1 -&gt; faultwrap authtoken keystonecontext ratelimit osapi_volume_app_v1</li>
</ul>


<h4><a name="sec49" id="sec49"></a>安装libvirt-bin</h4>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install libvirt-bin
</pre>
尝试载入网络块设备模块和kvm模块
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo modprobe ndb
sudo modprobe kvm
</pre>
测试一下kvm是否可用
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
file /dev/kvm # maybe other better command for test
</pre>
将用户加入libvirtd中，并且重启libvirt服务
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo usermod -a -G libvirtd <user>
sudo /etc/init.d/libvirt-bin restart
</pre>
创建nova instances目录
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
mkdir -p nova/instances
</pre>


<h4><a name="sec50" id="sec50"></a>清除iptables规则</h4>

<p class="first">略</p>


<h4><a name="sec51" id="sec51"></a>删除旧的instances</h4>

<p class="first">略</p>


<h4><a name="sec52" id="sec52"></a>建立nova-network文件夹</h4>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
rm -rf nova/networks
mkdir -p nova/networks
</pre>


<h4><a name="sec53" id="sec53"></a>配置储存服务</h4>

<p class="first">新建swift.img，初始化写入1G大小的0,然后格式化成xfs格式，并挂载。
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo mkdir -p swift/data/drives
sudo chown -R <user>:1000 swift/data
mkdir -p swift/data/drives/images
sudo touch swift/data/drives/images/swift.img
sudo chown <user>: swift/data/drives/images/swift.img
dd if=/dev/zero of=swift/data/drives/images/swift.img bs=1024 count=0 seek=1000000
mkfs.xfs -f -i size=1024 swift/data/drives/images/swift.img
sudo mount -t xfs -o loop, noatime, nodiratime, nobarrier, logbufs=8 swift/data/drives/sdb1
</pre>
创建链接
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo ln -sf swift/data/drives/sdb1/1 swift/data/1
sudo ln -sf swift/data/drives/sdb1/2 swift/data/2
sudo ln -sf swift/data/drives/sdb1/3 swift/data/3
sudo ln -sf swift/data/drives/sdb1/4 swift/data/4
sudo install -o <user> -g 1000 -d <directory> # <directory>以下内容替代,如果文件夹存在
# swift/data/drives/sdb1/1
# swift/data/drives/sdb1/2
# swift/data/drives/sdb1/3
# swift/data/drives/sdb1/4
# swift/data/1/node/sdb1
# swift/data/2/node/sdb1
# swift/data/3/node/sdb1
# swift/data/4/node/sdb1
# swift/config/object-server
# swift/config/container-server
# swift/config/account-server
# /var/run/swift
</pre>
改变权限
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo chown -R <user>: swift/data/1/node
sudo chown -R <user>: swift/data/2/node
sudo chown -R <user>: swift/data/3/node
sudo chown -R <user>: swift/data/4/node
sudo chown -R <user>: swift/config
</pre>
创建swift-init需要的/etc/swift(这是一个bug)
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo ln -sf swift/config /etc/swift
</pre></p>

<p>替换files/swift/rsyncd.conf的内容，然后写入/etc/rsyncd.conf</p>

<ul>
<li>%GROUP% -&gt; 1000</li>
<li>%USER% -&gt; user</li>
<li>%SWIFT_DATA_LOCATION% -&gt; /home/&lt;user&gt;/devstack/swift/data</li>
</ul>

<p>将/etc/default/rsync中RSYNC_ENABLE=false中的false改为true</p>

<p>安装memcached
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install memcached
</pre></p>

<p>安装特别版的bin/swift来支持openstack api 2.0
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo curl -s -o/usr/local/bin/swift 'https://review.openstack.org/gitweb?p=openstack/swift.git;a=blob_plain;f=bin/swift;hb=48bfda6e2fdf3886c98bd15649887d54b9a2574e'
</pre></p>

<p>替换files/swift/proxy-srever.conf的内容，然后写入swift/config/proxy-server.conf</p>

<ul>
<li>%SWIFT_CONFIG_LOCATION% -&gt; /home/&lt;user&gt;/devstack/swift/config</li>
<li>%USER% -&gt; &lt;user&gt;</li>
<li>%SREVICE_TOKEN% -&gt; &lt;service_token&gt;</li>
<li>%AUTH_SERVER% -&gt; keystone</li>
</ul>

<p>替换files/swift/swift.conf的内容，然后写入swift/config/swift.conf</p>

<ul>
<li>%SWIFT_HASH% -&gt; &lt;random_hash&gt;,&lt;random_hash&gt;为一个随机值</li>
</ul>

&lt;num&gt;依次取1-4
将files/swift/object-server.conf的内容替换，写入swift/config/object-server.conf

<ul>
<li>%SWIFT_CONFIG_LOCATION% -&gt; /home/&lt;user&gt;/devstack/swift/config</li>
<li>%USER% -&gt; &lt;user&gt;</li>
<li>%NODE_PATH% -&gt; swift/data/&lt;num&gt;</li>
<li>%BIND_PORT% -&gt; 6010</li>
<li>%LOG_FACILITY% -&gt; 2</li>
</ul>

<p>将files/swift/container-server.conf的内容替换，写入swift/config/object-server.conf</p>

<ul>
<li>%SWIFT_CONFIG_LOCATION% -&gt; /home/&lt;user&gt;/devstack/swift/config</li>
<li>%USER% -&gt; &lt;user&gt;</li>
<li>%NODE_PATH% -&gt; swift/data/&lt;num&gt;</li>
<li>%BIND_PORT% -&gt; 6011</li>
<li>%LOG_FACILITY% -&gt; 2</li>
</ul>

<p>将files/swift/account-server.conf的内容替换，写入swift/config/object-server.conf</p>

<ul>
<li>%SWIFT_CONFIG_LOCATION% -&gt; /home/&lt;user&gt;/devstack/swift/config</li>
<li>%USER% -&gt; &lt;user&gt;</li>
<li>%NODE_PATH% -&gt; swift/data/&lt;num&gt;</li>
<li>%BIND_PORT% -&gt; 6012</li>
<li>%LOG_FACILITY% -&gt; 2</li>
</ul>


<p>创建swift的日志目录
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
mkdir -p swift/data/logs/hourly
chown -R syslog:adm swift/data/logs/hourly
</pre></p>

<p>将files/swift/rsyslog.conf的内容替换，写入/etc/rsyslog.d/10-swift.conf</p>

<ul>
<li>%SWIFT_LOGDIR% swift/data/logs</li>
</ul>

<p>重启rsyslog
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo restart rsyslog
</pre></p>

<h5>创建帮助脚本</h5>

<p>略</p>



<h4><a name="sec54" id="sec54"></a>配置volume service</h4>

<p class="first">安装包
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo apt-get install tgt
</pre></p>

<h5>配置</h5>

<p>略</p>


<h5>重新启动</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
sudo stop tgt
sudo start tgt
</pre>



<h4><a name="sec55" id="sec55"></a>配置nova</h4>

<h5>重写nova.conf</h5>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
rm -f nova/bin/nova.conf
</pre>
在nova/bin/nova.conf中加入下面几行内容
<blockquote>
<p class="quoted">- &mdash;verbose</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;allow_admin_api</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;scheduler_driver=nova.scheduler.simple.SimpleScheduler</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;dhcpbridge_flagfile=/home/&lt;user&gt;/bin/nova.conf</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;fixed_rage=10.0.0.0/24</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;s3_host=&lt;host_ip&gt;</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;network_manager=nova.network.quantum.manager.QuantumManager</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;quantum_connection_host=localhost</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;quantum_connection_port=9696</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;quantum_ipam_lib=nova.network.quantum.melange_ipam_lib</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;use_melange_mac_generation</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;melange_host=localhost</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;melange_port=9898</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;libvirt_vif_type=ethernet</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;libvirt_vif_driver=nova.virt.libvirt.vif.LibvirtOpenVswitchDriver</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;linuxnet_interface_driver=nova.network.linux_net.LinuxOVSInterfaceDriver</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;quantum_use_dhcp</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;volume_group=nova-volumes</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;volume_name_template=volume-%08x</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;iscsi_helper=tgtadm</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;osapi_compute_extension=nova.api.oopenstack.compute.contrib.standard_extensions</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;my_ip=&lt;host_ip&gt;</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;public_interface=eth0</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;vlan_interface=eth0</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;sql_connection=mysql://root:&lt;mysql_passwd&gt;@localhost/nova</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;libvirt_type=kvm</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;instance_name_template=instace-%08x</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;novncproxy_base_url=&quot;http:/&lt;host_ip&gt;:6080/vnc_auto.html&quot;</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;xvpvncproxy_base_url=&quot;http://&lt;host_ip&gt;:6081/console</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;vncserver_listten=127.0.0.1</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;vncserver_proxyclient_client=127.0.0.1</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;api_paste_config=nova/bin/nova-api-paste.ini</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;image_service=nova.image.glance.GlanceImageService</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;ec2_dmz_host=eth0</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;rabbit_host=localhost</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;rabbit_password=&lt;rabbit_passwd&gt;</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;glance_api_servers=9292</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;force_dhcp_release</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;connection_type=libvirt</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;firewall_driver=nova.virt.libvirt.firewall.IptablesFirewallDriver</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;flat_network_bridge=br100</p>
</blockquote>

<blockquote>
<p class="quoted">- &mdash;flat_interface=eth0</p>
</blockquote>




<h4><a name="sec56" id="sec56"></a>配置nova数据库</h4>

<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
mysql -uroot -p<mysql_passwd> -e 'CREATE DATABASE nova;'
nova/bin/nova-manage db sync
</pre>


<h4><a name="sec57" id="sec57"></a>配置keystone</h4>

<p class="first">创建数据库
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
mysql -uroot -p<mysql_passwd> -e 'CREATE DATABASE keystone;'
nova/bin/nova-manage db sync
</pre>
替换files/keystone.conf，并写入到keystone/etc/keystone.conf</p>

<ul>
<li>%SQL_CON% -&gt; mysql://root:&lt;mysql_passwd&gt;@localhost/keystone</li>
<li>%DEST% -&gt; /home/&lt;user&gt;/devstack/keystone.conf</li>
</ul>

<p>替换files/keystone_data.sh，并写入到keystone/bin/keystone_data.sh</p>

<ul>
<li>%KEYSTONE_AUTH_HOST% -&gt; &lt;host_ip&gt;</li>
<li>%KEYSTONE_AUTH_PORT% -&gt; 35357</li>
<li>%KEYSTONE_AUTH_PROTOCOL% -&gt; http</li>
<li>%KEYSTONE_SERVICE_HOST% -&gt; &lt;host_ip&gt;</li>
<li>%KEYSTONE_SERVICE_PORT% -&gt; 5000</li>
<li>%KEYSTONE_SERVICE_PROTOCOL% -&gt; http</li>
<li>%SERVICE_HOST% -&gt; &lt;host_ip&gt;</li>
<li>%SERVICE_TOKEN -&gt; &lt;service_token&gt;</li>
<li>%ADMIN_PASSWORD%, &lt;admin_passwd&gt;</li>
</ul>

<p>让数据库准备就绪
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
keystone/bin/keystone-manage db sync_database
</pre></p>

<p>运行脚本
<pre class="brush:bash; gutter:true; toolbar:false; ruler:false;">
ENABLED_SERVICE=g-api,g-reg,key,n-api,n-crt,n-obj,n-cpu,n-net,n-sch,n-novnc,n-xvnc,n-cauth,horizon,mysql,rabbit \
BIN_DIR=/home/<user>/bin \
bash keystone/bin/keystone_data.sh
</pre></p>


<h4><a name="sec58" id="sec58"></a>开启服务</h4>

<p class="first">略</p>



<h4><a name="sec59" id="sec59"></a>未完待续。。。</h4>




<h2><a name="sec60" id="sec60"></a>ISO 安装</h2>

<p class="first">精简了的ubuntu linux server 10.04，并剔除了openstack不需要的包，所以大小只有300M左右。但是安装完之后还要到网站注册，收集机器信息，然后部署，比较麻烦，放在这里仅供参考</p>

<ul>
<li><a href="http://www.linuxso.com/linuxrumen/17399.html">介绍</a>、<a href="http://sourceforge.net/projects/stackops/files/">下载</a>、 <a href="http://docs.stackops.org.">文档</a>、 <a href="http://getsatisfaction.com/stackops">支持</a></li>
</ul>


<!-- Emacs Muse Footer -->

<div id="footer" align="center">
	<hr>
    Last Updated: February 11, 2012  
<span>  &nbsp &nbsp;    </span>       
   <img border="0" src="http://cc.amazingcounters.com/counter.php?i=3007311&c=9022246" alt="Hit Counter">
	<span>  &nbsp &nbsp;    </span>    
  <script language="javascript" type="text/javascript" src="http://js.users.51.la/5290848.js"></script>
<noscript><a href="http://www.51.la/?5290848" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="http://img.users.51.la/5290848.asp" style="border:none" /></a></noscript>

</div>
	<script type="text/javascript">
	     SyntaxHighlighter.all()
	</script>
</body>
</html>

